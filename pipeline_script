pipeline {
    agent any

    stages {
        stage ('STAGE 1 - PRE-QA_DEPLOYMENT_CHECK_FOR_MISSING_FILES') {
            steps {
                println "... executing pre-QA_deployment check for missing files"
                sh './chk.jenkins_wrkspc.sh index.html'
            }
        }
        stage ('STAGE 2 - QA_DEPLOY') {
            steps {
              println "... executing QA deployment stage"
              withCredentials([
                string(credentialsId: 'secret_webuser', variable: 'SECRETUSER'),
                string(credentialsId: 'secret_webhost', variable: 'SECRETHOST'),
                string(credentialsId: 'secret_profilekey', variable: 'SECRETKEY')
              ]){
                  // Random, generally increasing waittime is used since webhost site closes connection when repeated file transfers occur too quick.
                  // Copy all referenced files including parent html to QA location by doing the following:
                  // - execute sync.sh to create a list of all files that do not exist at webhost QA location or that may need updating (e.g sync.flist)
                  // - cross reference the list against list of files referenced by parent html, create required remote directories and scp files
                  sh ''' \
                    WRKDIR=`pwd` \
                    BASE_DIRNAME=`basename $WRKDIR` \
                    i=10 \
                    waitfloor=5 \
                    ./sync.sh 2>/dev/null \
                    cat $BASE_DIRNAME.flist | grep "^$BASE_DIRNAME" | sed "s#^$BASE_DIRNAME/##" | sort > ref.flist \
                    echo "" \
                    echo "--- FILES TO SYNC ---" \
#                    common=`comm -12 sync.flist ref.flist | grep "[A-Za-z]" | grep -v "^ *$"` \
#                    if [[ ! -z $common ]];then \
                      comm -12 sync.flist ref.flist \
                      comm -12 sync.flist ref.flist | while read f;do dirname $f;done | sort -u | grep -v "^.\$" | while read dir;do ssh -i ${SECRETKEY} ${SECRETUSER}@${SECRETHOST} "mkdir -p /home/ar4jf2nz/public_html/QA_${BASE_DIRNAME}/$dir";done \
                      comm -12 sync.flist ref.flist | while read f;do \
                           waittime=$(($(($RANDOM % 15))+$waitfloor)) \
                           scp -p -i ${SECRETKEY} $f ${SECRETUSER}@${SECRETHOST}:/home/ar4jf2nz/public_html/QA_${BASE_DIRNAME}/$f \
                           sleep $waittime \
                           i=$(($i+1)) \
                           waitfloor=$(($i/5)) \
#                      done \
#                    else \
#                      echo "No files need to be syncd" \
#                    fi
                  '''
              }
            }
        }
        stage ('STAGE 3 - QA_TEST') {
            steps {
                println "... executing QA test stage: (1) test home page and (2) test referenced links"
            }
        }
        stage ('STAGE 4 - PROD_DEPLOY') {
            steps {
                println "... executing PROD deployment stage"
            }
        }
        stage ('STAGE 5 - REPORT_VALID_FILES') {
            steps {
                println "... executing report valid files stage"
            }
        }
        stage ('STAGE 6 - REPORT_UNUSED_FILES') {
            steps {
                println "... executing report unused files stage"
            }
        }
    }
}
