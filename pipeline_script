pipeline {
    agent any

    stages {
        stage ('Pre-QA_Deployment_Missing_File_Check') {
            steps {
                println "... executing pre-QA_deployment check for missing files"
                sh './qa_chk.sh index.html'
            }
        }
        stage ('QA_Deploy') {
            steps {
              withCredentials([
                string(credentialsId: 'secret_webuser', variable: 'SECRETUSER'),
                string(credentialsId: 'secret_webhost', variable: 'SECRETHOST'),
                string(credentialsId: 'secret_profilekey', variable: 'SECRETKEY')
              ]){
//   waittime is used because webhost site closes scp connection when repeated file transfers occur too quickly
//                  sh 'ls -lrt | egrep -v "^d|list\$|^total" | sed "s#^.* ##" | while read f; do waittime=$(($RANDOM % 25)); sleep $waittime; scp -p -i ${SECRETKEY} $f ${SECRETUSER}@${SECRETHOST}:/home/ar4jf2nz/public_html/QA; done'
                  sh 'WRKDIR=`pwd`; BASE_DIRNAME=`basename $WRKDIR`; cat $BASE_DIRNAME.flist | grep "^$BASE_DIRNAME" | while read f; do waittime=$(($RANDOM % 25)); scp -p -i ${SECRETKEY} ../$f ${SECRETUSER}@${SECRETHOST}:/home/ar4jf2nz/public_html/QA; done'

                  println "... executing QA deployment stage"
              }
            }
        }
        stage ('QA_Test') {
            steps {
                println "... executing QA test stage: (1) test home page and (2) test referenced links"
            }
        }
        stage ('PROD_Deploy') {
            steps {
                sh 'echo "... printing list of files from github"'
                sh 'ls -lrt'
                println "... if QA test stage succeeds, executing PROD deployment stage"
            }
        }
        stage ('Report_Valid_Files') {
            steps {
                println "... if PROD deployment succeeds, executing report valid files stage"
            }
        }
        stage ('Report_Obsolete_Files') {
            steps {
                println "... executing report obsolete files stage"
            }
        }
    }
}
